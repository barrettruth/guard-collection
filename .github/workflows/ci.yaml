name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 2.0.2
          args: --check .

  test-pip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install tools
        run: pip install -q -r .github/tools/pip.txt
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/pip/*_spec.lua

  test-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install tools
        run: xargs npm install -g < .github/tools/npm.txt
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/npm/*_spec.lua

  test-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: false
      - name: Install tools
        run: |
          xargs -L1 go install < .github/tools/go.txt
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
      - name: Run tests
        run: |
          export PATH="$HOME/go/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/go/*_spec.lua

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/rust/*_spec.lua

  test-lua:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - name: Install tools
        run: |
          luarocks install luacheck --local
          luarocks install fnlfmt --local
          bash .github/scripts/install-binary-tools.sh "$HOME/.local/bin" .github/tools/lua-binary.txt
      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/lua/*_spec.lua

  test-binary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: dart-lang/setup-dart@v1
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Install tools
        run: |
          xargs sudo apt-get install -y < .github/tools/binary-apt.txt
          bash .github/scripts/install-binary-tools.sh "$HOME/.local/bin"
      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/binary/*_spec.lua

  test-apt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - name: Install tools
        run: xargs sudo apt-get install -y < .github/tools/apt.txt
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/apt/*_spec.lua

  test-dotnet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'
      - name: Install tools
        run: dotnet tool install -g csharpier
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/dotnet/*_spec.lua

  test-ruby:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - name: Install tools
        run: gem install rubocop
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/ruby/*_spec.lua

  test-elixir:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: erlef/setup-beam@v1
        with:
          otp-version: '27'
          elixir-version: '1.17'
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/elixir/*_spec.lua

  test-nix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: cachix/install-nix-action@v27
      - name: Install tools
        run: nix profile install nixpkgs#nixfmt-rfc-style
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/nix/*_spec.lua

  test-swift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/test-setup
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/swift/*_spec.lua

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 2.0.2
          args: --check .

  test-pip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          pip install -q autopep8 black cmake-format codespell cpplint djhtml docformatter flake8 isort mdformat pylint ruff sqlfluff yamlfix yapf
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/pip/*_spec.lua

  test-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          npm install -g prettier @biomejs/biome sql-formatter @taplo/cli eslint eslint_d stylelint npm-groovy-lint
          luarocks install busted --local
          luarocks install nlua --local
      - name: Pre-warm npm-groovy-lint
        run: npm-groovy-lint --help || true
        timeout-minutes: 10
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/npm/*_spec.lua

  test-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: false
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install mvdan.cc/gofumpt@latest
          go install github.com/segmentio/golines@latest
          go install github.com/google/yamlfmt/cmd/yamlfmt@latest
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export PATH="$HOME/go/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/go/*_spec.lua

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install test tools
        run: |
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/rust/*_spec.lua

  test-lua:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          luarocks install busted --local
          luarocks install nlua --local
          luarocks install luacheck --local
          luarocks install fnlfmt --local
          mkdir -p $HOME/.local/bin
          wget -q https://github.com/Kampfkarren/selene/releases/download/0.28.0/selene-0.28.0-linux.zip
          unzip -q selene-0.28.0-linux.zip -d $HOME/.local/bin
          chmod +x $HOME/.local/bin/selene
          wget -q https://github.com/JohnnyMorganz/StyLua/releases/download/v2.0.2/stylua-linux-x86_64.zip
          unzip -q stylua-linux-x86_64.zip -d $HOME/.local/bin
          chmod +x $HOME/.local/bin/stylua
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/lua/*_spec.lua

  test-binary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: dart-lang/setup-dart@v1
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          sudo apt-get install -y zsh jq libxml2-utils shellcheck fish pgformatter
          luarocks install busted --local
          luarocks install nlua --local
          mkdir -p $HOME/.local/bin
          cd $HOME/.local/bin
          wget -q https://github.com/kamadorueda/alejandra/releases/download/4.0.0/alejandra-x86_64-unknown-linux-musl -O alejandra && chmod +x alejandra
          wget -q https://github.com/bufbuild/buf/releases/download/v1.47.2/buf-Linux-x86_64 -O buf && chmod +x buf
          wget -q https://github.com/mrtazz/checkmake/releases/download/0.2.2/checkmake-0.2.2.linux.amd64 -O checkmake && chmod +x checkmake
          wget -q https://github.com/denoland/deno/releases/download/v2.1.4/deno-x86_64-unknown-linux-gnu.zip && unzip -q deno-x86_64-unknown-linux-gnu.zip && chmod +x deno
          wget -q https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64 -O hadolint && chmod +x hadolint
          wget -q https://github.com/crate-ci/typos/releases/download/v1.43.3/typos-v1.43.3-x86_64-unknown-linux-musl.tar.gz -O typos.tar.gz && tar xzf typos.tar.gz && chmod +x typos && rm typos.tar.gz
          wget -q https://github.com/typstyle-rs/typstyle/releases/download/v0.14.4/typstyle-x86_64-unknown-linux-gnu -O typstyle && chmod +x typstyle
          wget -q https://github.com/cmhughes/latexindent.pl/releases/download/V3.24.4/latexindent-linux -O latexindent && chmod +x latexindent
          wget -q https://github.com/mvdan/sh/releases/download/v3.10.0/shfmt_v3.10.0_linux_amd64 -O shfmt && chmod +x shfmt
          wget -q https://github.com/nicklockwood/SwiftFormat/releases/download/0.55.3/swiftformat_linux.zip && unzip -q swiftformat_linux.zip && mv swiftformat_linux swiftformat && chmod +x swiftformat
          wget -q https://github.com/lukas-reineke/cbfmt/releases/download/v0.2.0/cbfmt_linux-x86_64_v0.2.0.tar.gz -O cbfmt.tar.gz && tar xzf cbfmt.tar.gz -C . cbfmt_linux-x86_64_v0.2.0/cbfmt --strip-components=1 && chmod +x cbfmt && rm cbfmt.tar.gz
          wget -q https://github.com/pinterest/ktlint/releases/download/1.8.0/ktlint && chmod +x ktlint
          wget -q https://github.com/google/google-java-format/releases/download/v1.34.1/google-java-format-1.34.1-all-deps.jar && printf '#!/bin/sh\njava -jar %s/google-java-format-1.34.1-all-deps.jar "$@"\n' "$HOME/.local/bin" > google-java-format && chmod +x google-java-format
          wget -q https://github.com/tombi-toml/tombi/releases/download/v0.7.27/tombi-cli-0.7.27-x86_64-unknown-linux-musl.gz -O tombi.gz && gunzip tombi.gz && chmod +x tombi
          wget -q https://github.com/detekt/detekt/releases/download/v1.23.7/detekt-cli-1.23.7-all.jar && printf '#!/bin/sh\njava -jar %s/detekt-cli-1.23.7-all.jar "$@"\n' "$HOME/.local/bin" > detekt && chmod +x detekt
          wget -q https://repo1.maven.org/maven2/com/facebook/ktfmt/0.52/ktfmt-0.52-jar-with-dependencies.jar && printf '#!/bin/sh\njava -jar %s/ktfmt-0.52-jar-with-dependencies.jar "$@"\n' "$HOME/.local/bin" > ktfmt && chmod +x ktfmt
          wget -q https://github.com/dprint/dprint/releases/download/0.49.0/dprint-x86_64-unknown-linux-gnu.zip && unzip -q dprint-x86_64-unknown-linux-gnu.zip -d . && chmod +x dprint
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/binary/*_spec.lua

  test-clang:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          sudo apt-get install -y clang-format clang-tidy
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          for f in test/clang/*_spec.lua; do busted --lua nlua "$f"; done

  test-haskell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.8'
          cabal-version: latest
      - uses: actions/cache@v4
        with:
          path: ~/.cabal
          key: cabal-${{ runner.os }}-9.8-hlint
          restore-keys: cabal-${{ runner.os }}-9.8-
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          cabal update
          cabal install hlint --overwrite-policy=always
          cabal install ormolu --overwrite-policy=always
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export PATH="$HOME/.cabal/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/haskell/*_spec.lua

  test-dotnet:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          dotnet tool install -g csharpier
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/dotnet/*_spec.lua

  test-ruby:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          gem install rubocop bundler
          luarocks install busted --local
          luarocks install nlua --local
      - name: Setup rubocop Gemfile
        run: |
          mkdir -p /tmp/rubocop-test
          printf "source 'https://rubygems.org'\ngem 'rubocop'\n" > /tmp/rubocop-test/Gemfile
          cd /tmp/rubocop-test && bundle install
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/ruby/*_spec.lua

  test-clojure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install Clojure CLI
        run: |
          curl -L -O https://github.com/clojure/brew-install/releases/latest/download/linux-install.sh
          chmod +x linux-install.sh
          sudo ./linux-install.sh
      - name: Install tools
        run: |
          mkdir -p $HOME/.local/bin
          printf '#!/bin/sh\nclojure -Sdeps '"'"'{:deps {dev.weavejester/cljfmt {:mvn/version "0.13.0"}}}'"'"' -M -m cljfmt.main "$@"\n' > $HOME/.local/bin/cljfmt && chmod +x $HOME/.local/bin/cljfmt
          luarocks install busted --local
          luarocks install nlua --local
      - name: Pre-warm cljfmt deps
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "" | cljfmt fix - || true
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/clojure/*_spec.lua

  test-elixir:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: erlef/setup-beam@v1
        with:
          otp-version: '27'
          elixir-version: '1.17'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/elixir/*_spec.lua

  test-nix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: cachix/install-nix-action@v27
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          nix profile install nixpkgs#nixfmt-rfc-style
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/nix/*_spec.lua

  test-swift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/swift/*_spec.lua

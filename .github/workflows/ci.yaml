name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: JohnnyMorganz/stylua-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: 2.0.2
          args: --check .

  test-pip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: nightly
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: leso-kn/gh-actions-lua@master
        with:
          luaVersion: "5.1"
      - uses: hishamhm/gh-actions-luarocks@master
      - name: Install tools
        run: |
          pip install -q black flake8
          luarocks install busted --local
          luarocks install nlua --local
      - name: Clone guard.nvim
        run: git clone --depth 1 https://github.com/nvimdev/guard.nvim && mv guard.nvim/lua/guard lua/
      - name: Run tests
        run: |
          export LUA_PATH="lua/?.lua;lua/?/init.lua;$LUA_PATH"
          busted --lua nlua test/pip/*_spec.lua
